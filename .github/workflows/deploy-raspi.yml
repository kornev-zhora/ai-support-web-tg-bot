name: Deploy to Raspberry Pi (Self-Hosted)

on:
  repository_dispatch:
    types: [deploy-to-raspi] # Запускається після успішної збірки та push

jobs:
  deploy:
    runs-on: [self-hosted, linux, raspi-deploy] # Використовуємо ваш Raspberry Pi Runner
    steps:
      - name: 1. Get Image Tag from Payload
        # Отримуємо тег образу, який щойно був зібраний (використовуємо SHA коміту)
        id: get_tag
        run: |
          IMAGE_TAG=$(jq --raw-output .client_payload.image_tag "$GITHUB_EVENT_PATH")
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
        env:
          # Встановіть jq, якщо його немає на вашому Pi: sudo apt install jq
          # Це дозволяє парсити JSON, що передається
          DEBIAN_FRONTEND: noninteractive

      - name: 2. Login to Docker Hub
        # Потрібен для отримання приватного образу
        run: docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

      - name: 3. Pull and Stop Old Container
        # Отримання нового образу та зупинка старого контейнера
        run: |
          IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/ai-support-bot

          # 3.1. Отримання нового образу
          docker pull $IMAGE_NAME:${{ env.IMAGE_TAG }}

          # 3.2. Зупинка старого контейнера (якщо існує)
          CONTAINER_ID=$(docker ps -aq --filter "name=ai-support-bot")
          if [ ! -z "$CONTAINER_ID" ]; then
            docker stop $CONTAINER_ID
            docker rm $CONTAINER_ID
          fi

          # 3.3. Видалення старих образів
          docker image prune -f

      - name: 4. Run New Container
        run: |
          IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/ai-support-bot

          # Запустіть новий контейнер, використовуючи необхідні порти та змінні середовища
          docker run -d \
          --name ai-support-bot \
          -p 80:80 \
          -e APP_ENV=production \
          $IMAGE_NAME:${{ env.IMAGE_TAG }}

      - name: 5. Deployment Completed on Raspberry Pi
        run: echo "Successfully deployed tag ${{ env.IMAGE_TAG }} on Raspberry Pi."