name: Deploy to Raspberry Pi (Self-Hosted)

on:
  repository_dispatch:
    types: [deploy-to-raspi] # Запускається після успішної збірки та push

jobs:
  deploy:
    runs-on: [self-hosted, linux, raspi-deploy] # Використовуємо ваш Raspberry Pi Runner
    environment: raspberry
    steps:
      - name: 1. Get Image Tag from Payload
        # Отримуємо тег образу, який щойно був зібраний (використовуємо SHA коміту)
        id: get_tag
        run: |
          IMAGE_TAG=$(jq --raw-output .client_payload.image_tag "$GITHUB_EVENT_PATH")
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
        env:
          # Встановіть jq, якщо його немає на вашому Pi: sudo apt install jq
          # Це дозволяє парсити JSON, що передається
          DEBIAN_FRONTEND: noninteractive

      - name: 2. Checkout Repository
        uses: actions/checkout@v4

      - name: 3. Login to Docker Hub
        # Потрібен для отримання приватного образу
        run: docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

      - name: 4. Pull and Stop Old Container
        # Отримання нового образу та зупинка старого контейнера
        run: |
          IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/ai-support-bot

          # 3.1. Отримання нового образу
          docker pull $IMAGE_NAME:${{ env.IMAGE_TAG }}

          # 3.2. Зупинка старого контейнера (якщо існує)
          CONTAINER_ID=$(docker ps -aq --filter "name=ai-support-bot")
          if [ ! -z "$CONTAINER_ID" ]; then
            docker stop $CONTAINER_ID
            docker rm $CONTAINER_ID
          fi

          # 3.3. Видалення старих образів
          docker image prune -f

      - name: 5. Deploy with Docker Compose
        run: |
          # Create environment file
          cat > .env << EOF
          APP_NAME="${{ vars.APP_NAME || 'AI Support Bot' }}"
          APP_ENV=production
          APP_DEBUG=false
          APP_KEY="${{ secrets.APP_KEY }}"
          APP_URL="${{ vars.APP_URL }}"
          APP_PORT=${{ vars.APP_PORT || 8060 }}
          WWWUSER=${{ vars.WWWUSER || 1000 }}
          WWWGROUP=${{ vars.WWWGROUP || 1000 }}

          DB_CONNECTION=pgsql
          DB_HOST=${{ vars.DB_HOST || 'localhost' }}
          DB_PORT=${{ vars.DB_PORT || '5432' }}
          DB_DATABASE=${{ vars.DB_DATABASE || 'ai-bot' }}
          DB_USERNAME=${{ vars.DB_USERNAME || 'github' }}
          DB_PASSWORD=${{ vars.DB_PASSWORD }}

          REDIS_HOST=${{ vars.REDIS_HOST || 'localhost' }}
          REDIS_PORT=${{ vars.REDIS_PORT || '6379' }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}

          GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}"
          GEMINI_MODEL="${{ vars.GEMINI_MODEL || 'gemini-2.5-flash' }}"
          TELEGRAM_TOKEN="${{ secrets.TELEGRAM_TOKEN }}"
          TELEGRAM_BOT_USERNAME="${{ vars.TELEGRAM_BOT_USERNAME }}"

          DOCKER_IMAGE=${{ secrets.DOCKER_USERNAME }}/ai-support-bot:${{ env.IMAGE_TAG }}
          EOF

          # Copy override file and start services
          cp compose.override.raspberry.yml compose.override.yml
          docker compose up -d

          # Wait for container to be fully up
          echo "Waiting for container to start..."
          for i in {1..30}; do
            if docker exec ai-support-bot test -f /var/www/html/artisan; then
              echo "Container is ready"
              break
            fi
            echo "Attempt $i/30: Waiting..."
            sleep 2
          done

          # Ensure storage directories have correct permissions
          docker exec ai-support-bot chown -R sail:sail /var/www/html/storage
          docker exec ai-support-bot chmod -R 775 /var/www/html/storage

      - name: 6. Run Database Migrations and Cache
        run: |
          # Clear and optimize caches
          docker exec ai-support-bot php artisan config:clear || true
          docker exec ai-support-bot php artisan cache:clear || true
          docker exec ai-support-bot php artisan route:clear || true
          docker exec ai-support-bot php artisan view:clear || true

          # Run migrations
          docker exec ai-support-bot php artisan migrate --force

          # Optimize for production
          docker exec ai-support-bot php artisan config:cache
          docker exec ai-support-bot php artisan route:cache
          docker exec ai-support-bot php artisan view:cache

      - name: 7. Verify Deployment
        run: |
          echo "=== Container Status ==="
          docker ps --filter "name=ai-support-bot"

          echo ""
          echo "=== Application Health ==="
          docker exec ai-support-bot php artisan --version || echo "Laravel not responding"

          echo ""
          echo "✅ Successfully deployed tag ${{ env.IMAGE_TAG }} on Raspberry Pi"
